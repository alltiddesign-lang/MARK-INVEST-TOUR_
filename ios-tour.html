<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <title>MARK INVEST TOUR | –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ</title>
  <meta name="description" content="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ" />
  <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg" />
  <link rel="apple-touch-icon" type="image/png" href="/assets/images/180.png" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif;
      color: #ffffff;
      background: #050505;
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(5, 5, 5, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.12em;
    }

    .logo span {
      color: #ff4b4b;
    }

    .back-btn {
      background: none;
      border: none;
      color: #ffffff;
      font-size: 16px;
      cursor: pointer;
      padding: 8px;
      -webkit-tap-highlight-color: rgba(255, 75, 75, 0.2);
    }

    .back-btn:active {
      opacity: 0.7;
    }

    /* Hero Section */
    .tour-hero {
      position: relative;
      width: 100%;
      min-height: 50vh;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      align-items: flex-end;
      padding: 32px 16px;
    }

    .tour-hero::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.8));
    }

    .tour-hero-content {
      position: relative;
      z-index: 1;
      width: 100%;
    }

    .tour-title {
      font-size: 28px;
      font-weight: 600;
      line-height: 1.2;
      margin-bottom: 16px;
    }

    .tour-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 14px;
      color: rgba(245,244,240,0.8);
    }

    .tour-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Content Section */
    .tour-content {
      padding: 32px 16px;
      background: #050505;
    }

    .tour-section {
      margin-bottom: 32px;
    }

    .tour-section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .tour-price {
      font-size: 32px;
      font-weight: 600;
      color: #ff4b4b;
      margin-bottom: 24px;
    }

    .tour-description {
      font-size: 16px;
      line-height: 1.6;
      color: rgba(245,244,240,0.9);
      margin-bottom: 24px;
    }

    .tour-details {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .tour-detail-item {
      background: rgba(15,15,15,0.86);
      border: 1px solid rgba(245,244,240,0.18);
      border-radius: 12px;
      padding: 16px;
    }

    .tour-detail-label {
      font-size: 12px;
      color: rgba(245,244,240,0.6);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tour-detail-value {
      font-size: 16px;
      font-weight: 500;
      color: #ffffff;
    }

    /* Gallery */
    .tour-gallery {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 24px;
    }

    .tour-gallery-item {
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      width: 100%;
    }

    /* Booking Form */
    .booking-section {
      background: rgba(15,15,15,0.5);
      padding: 32px 16px;
      border-radius: 16px;
      margin-top: 32px;
    }

    .booking-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 14px;
      color: rgba(245,244,240,0.8);
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      border-radius: 999px;
      border: 1px solid rgba(245,244,240,0.18);
      background: rgba(15,15,15,0.86);
      color: #ffffff;
      font-size: 15px;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-input:focus {
      outline: none;
      border-color: #ff4b4b;
    }

    .form-input::placeholder {
      color: rgba(245,244,240,0.5);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      border-radius: 999px;
      border: none;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: opacity 0.2s;
      -webkit-tap-highlight-color: rgba(255, 75, 75, 0.2);
    }

    .btn:active {
      opacity: 0.8;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff4b4b, #ff7a45);
      color: #ffffff;
      width: 100%;
    }

    /* Loading & Error States */
    .loading, .error {
      text-align: center;
      padding: 60px 16px;
      color: rgba(245,244,240,0.6);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 75, 75, 0.3);
      border-top-color: #ff4b4b;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      color: #ff4b4b;
    }

    /* Contacts */
    .contacts {
      padding: 32px 16px;
      text-align: center;
      background: #050505;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .contacts-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .contacts-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .contacts-link {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      font-size: 16px;
      -webkit-tap-highlight-color: rgba(255, 75, 75, 0.2);
    }

    .contacts-link:active {
      opacity: 0.7;
    }

    /* Programs Section */
    .programs-scroll {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      display: flex;
      gap: 16px;
      padding: 8px 0;
    }

    .programs-scroll::-webkit-scrollbar {
      display: none;
    }

    .program-day {
      flex: 0 0 85%;
      background: rgba(15,15,15,0.86);
      border: 1px solid rgba(245,244,240,0.18);
      border-radius: 16px;
      overflow: hidden;
      scroll-snap-align: start;
    }

    .program-day-image {
      width: 100%;
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .program-day-badges {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .program-day-badge {
      background: rgba(5, 5, 5, 0.8);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #ffffff;
    }

    .program-day-content {
      padding: 20px;
    }

    .program-day-description {
      font-size: 14px;
      line-height: 1.6;
      color: rgba(245,244,240,0.9);
    }

    .program-day-description p {
      margin-bottom: 12px;
    }

    .program-day-description p:last-child {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <header class="header">
    <button class="back-btn" onclick="window.history.back()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="logo">MARK INVEST<span>TOUR</span></div>
    <div style="width: 60px;"></div> <!-- Spacer for centering -->
  </header>

  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p style="margin-top: 16px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–∞...</p>
  </div>

  <div id="error" class="error" style="display: none;">
    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–∞</p>
  </div>

  <div id="tour-content" style="display: none;">
    <section class="tour-hero" id="tour-hero">
      <div class="tour-hero-content">
        <h1 class="tour-title" id="tour-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
        <div class="tour-meta" id="tour-meta"></div>
      </div>
    </section>

    <section class="tour-content">
      <div class="tour-section">
        <div class="tour-price" id="tour-price" style="display: none;"></div>
        <div class="tour-description" id="tour-description"></div>
      </div>

      <div class="tour-section" id="tour-details-section" style="display: none;">
        <h2 class="tour-section-title">–î–µ—Ç–∞–ª–∏ —Ç—É—Ä–∞</h2>
        <div class="tour-details" id="tour-details"></div>
      </div>

      <div class="tour-section" id="tour-gallery-section" style="display: none;">
        <h2 class="tour-section-title">–ì–∞–ª–µ—Ä–µ—è</h2>
        <div class="tour-gallery" id="tour-gallery"></div>
      </div>

      <div class="tour-section" id="tour-programs-section" style="display: none;">
        <h2 class="tour-section-title">–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—É—Ä–∞</h2>
        <div class="programs-scroll" id="programs-scroll">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã...</p>
          </div>
        </div>
      </div>

      <div class="booking-section">
        <h2 class="tour-section-title">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä</h2>
        <form id="booking-form" class="booking-form">
          <div class="form-group">
            <label class="form-label" for="booking-name">–ò–º—è</label>
            <input type="text" id="booking-name" class="form-input" placeholder="–í–∞—à–µ –∏–º—è" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="booking-phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="booking-phone" class="form-input" placeholder="+7 (999) 123-45-67" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="booking-email">Email</label>
            <input type="email" id="booking-email" class="form-input" placeholder="your@email.com" required />
          </div>
          <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
          <div id="booking-success" style="display: none; color: #4caf50; text-align: center; margin-top: 16px;">
            –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.
          </div>
          <div id="booking-error" style="display: none; color: #ff4b4b; text-align: center; margin-top: 16px;">
            –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
          </div>
        </form>
      </div>
    </section>

    <section class="contacts">
      <h3 class="contacts-title">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</h3>
      <div class="contacts-links">
        <a href="tel:+79259009000" class="contacts-link">+7 925 900 9000</a>
        <a href="https://api.whatsapp.com/send/?phone=79259009000" target="_blank" class="contacts-link">WhatsApp</a>
      </div>
    </section>
  </div>

  <script>
    const API_URL = window.API_URL || '/api';

    // –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Ç—É—Ä–∞ –∏–∑ URL
    function getTourIdFromUrl() {
      const path = window.location.pathname;
      const match = path.match(/\/tour\/(\d+)/);
      if (match) return parseInt(match[1]);
      
      // Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º query –ø–∞—Ä–∞–º–µ—Ç—Ä
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      return id ? parseInt(id) : null;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('ru-RU', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
      });
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    function formatDateRange(startDate, endDate) {
      if (!startDate && !endDate) return '';
      if (!endDate) return formatDate(startDate);
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
        return `${start.getDate()} - ${end.getDate()} ${end.toLocaleDateString('ru-RU', { month: 'long' })} ${end.getFullYear()}`;
      } else {
        return `${formatDate(startDate)} - ${formatDate(endDate)}`;
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const contentEl = document.getElementById('tour-content');
      
      if (loadingEl) loadingEl.style.display = 'none';
      if (contentEl) contentEl.style.display = 'none';
      if (errorEl) {
        errorEl.style.display = 'block';
        errorEl.textContent = message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–∞';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–∞
    async function loadTourData() {
      const tourId = getTourIdFromUrl();
      
      if (!tourId) {
        showError('–ù–µ–≤–µ—Ä–Ω—ã–π ID —Ç—É—Ä–∞');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/tours/${tourId}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            showError('–¢—É—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
          } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–∞');
          }
          return;
        }
        
        const tour = await response.json();
        
        if (!tour || !tour.id) {
          showError('–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞');
          return;
        }
        
        displayTourData(tour);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–∞:', error);
        showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–∞
    function displayTourData(tour) {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const contentEl = document.getElementById('tour-content');
      
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) errorEl.style.display = 'none';
      if (contentEl) contentEl.style.display = 'block';
      
      // Title
      document.title = `${tour.title} | MARK INVEST TOUR`;
      
      // Hero image
      const heroEl = document.getElementById('tour-hero');
      if (heroEl) {
        let imageUrl = '/assets/images/hero_background-min.jpg';
        if (tour.image_url) {
          imageUrl = tour.image_url.startsWith('http') ? tour.image_url : tour.image_url.startsWith('/') ? tour.image_url : `/${tour.image_url}`;
        } else if (tour.image) {
          imageUrl = tour.image.startsWith('http') ? tour.image : tour.image.startsWith('/') ? tour.image : `/uploads/${tour.image}`;
        }
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
        const img = new Image();
        img.onload = function() {
          heroEl.style.backgroundImage = `url('${imageUrl}')`;
          heroEl.classList.add('loaded');
        };
        img.onerror = function() {
          // Fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          heroEl.style.backgroundImage = `url('/assets/images/hero_background-min.jpg')`;
          heroEl.classList.add('loaded');
        };
        img.src = imageUrl;
      }
      
      // Title
      const titleEl = document.getElementById('tour-title');
      if (titleEl) titleEl.textContent = tour.title || '–¢—É—Ä';
      
      // Meta
      const metaEl = document.getElementById('tour-meta');
      if (metaEl) {
        const metaItems = [];
        if (tour.date_start || tour.date_end) {
          const dateRange = formatDateRange(tour.date_start, tour.date_end);
          if (dateRange) metaItems.push(`<div class="tour-meta-item">üìÖ ${dateRange}</div>`);
        }
        if (tour.duration) {
          metaItems.push(`<div class="tour-meta-item">‚è± ${tour.duration}</div>`);
        }
        if (tour.location) {
          metaItems.push(`<div class="tour-meta-item">üìç ${tour.location}</div>`);
        }
        metaEl.innerHTML = metaItems.join('');
      }
      
      // Price
      const priceEl = document.getElementById('tour-price');
      if (priceEl && tour.price) {
        priceEl.textContent = `${tour.price.toLocaleString('ru-RU')} ‚ÇΩ`;
        priceEl.style.display = 'block';
      }
      
      // Description
      const descEl = document.getElementById('tour-description');
      if (descEl) {
        descEl.textContent = tour.description || tour.short_description || '–û–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
      }
      
      // Details
      const detailsEl = document.getElementById('tour-details');
      const detailsSection = document.getElementById('tour-details-section');
      if (detailsEl) {
        const details = [];
        if (tour.duration) {
          details.push(`
            <div class="tour-detail-item">
              <div class="tour-detail-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
              <div class="tour-detail-value">${tour.duration}</div>
            </div>
          `);
        }
        if (tour.location) {
          details.push(`
            <div class="tour-detail-item">
              <div class="tour-detail-label">–ú–µ—Å—Ç–æ</div>
              <div class="tour-detail-value">${tour.location}</div>
            </div>
          `);
        }
        if (tour.max_participants) {
          const available = tour.max_participants - (tour.current_participants || 0);
          details.push(`
            <div class="tour-detail-item">
              <div class="tour-detail-label">–î–æ—Å—Ç—É–ø–Ω–æ –º–µ—Å—Ç</div>
              <div class="tour-detail-value">${available} –∏–∑ ${tour.max_participants}</div>
            </div>
          `);
        }
        if (details.length > 0) {
          detailsEl.innerHTML = details.join('');
          if (detailsSection) detailsSection.style.display = 'block';
        }
      }
      
      // Gallery - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ API
      const galleryEl = document.getElementById('tour-gallery');
      const gallerySection = document.getElementById('tour-gallery-section');
      if (galleryEl) {
        loadTourGallery(tour.id, galleryEl, gallerySection);
      }

      // Programs - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—É—Ä–∞
      loadTourPrograms(tour);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    function initBookingForm() {
      const form = document.getElementById('booking-form');
      if (!form) return;
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const tourId = getTourIdFromUrl();
        if (!tourId) {
          alert('–û—à–∏–±–∫–∞: ID —Ç—É—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const name = document.getElementById('booking-name').value.trim();
        const phone = document.getElementById('booking-phone').value.trim();
        const email = document.getElementById('booking-email').value.trim();
        
        if (!name || !phone || !email) {
          alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
          return;
        }
        
        const successEl = document.getElementById('booking-success');
        const errorEl = document.getElementById('booking-error');
        
        try {
          const response = await fetch(`${API_URL}/applications`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              tour_id: tourId,
              name,
              phone,
              email,
            }),
          });
          
          if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏');
          }
          
          if (successEl) {
            successEl.style.display = 'block';
            form.reset();
            setTimeout(() => {
              successEl.style.display = 'none';
            }, 5000);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
          if (errorEl) {
            errorEl.style.display = 'block';
            setTimeout(() => {
              errorEl.style.display = 'none';
            }, 5000);
          }
        }
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—É—Ä–∞
    function loadTourPrograms(tour) {
      const programsScroll = document.getElementById('programs-scroll');
      const programsSection = document.getElementById('tour-programs-section');
      
      if (!programsScroll || !programsSection) return;

      if (!tour.programs || tour.programs.length === 0) {
        programsSection.style.display = 'none';
        return;
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ –Ω–æ–º–µ—Ä—É –¥–Ω—è
      const sortedPrograms = [...tour.programs].sort((a, b) => (a.day || 0) - (b.day || 0));

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—É—Ä–∞
      let imageUrl = '/assets/images/hero_background-min.jpg';
      if (tour.image_url) {
        imageUrl = tour.image_url.startsWith('http') ? tour.image_url : tour.image_url.startsWith('/') ? tour.image_url : `/${tour.image_url}`;
      } else if (tour.image) {
        imageUrl = tour.image.startsWith('http') ? tour.image : tour.image.startsWith('/') ? tour.image : `/uploads/${tour.image}`;
      }

      // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
      const startDate = tour.date_start ? new Date(tour.date_start) : null;

      programsScroll.innerHTML = sortedPrograms.map((program, index) => {
        // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
        let dayDate = '';
        if (startDate) {
          const programDate = new Date(startDate);
          programDate.setDate(programDate.getDate() + (program.day - 1));
          dayDate = programDate.toLocaleDateString('ru-RU', { 
            day: 'numeric', 
            month: 'long' 
          });
        }

        // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
        const programText = program.programm || '';
        const paragraphs = programText.split(/\n\n|\n/).filter(p => p.trim());

        return `
          <div class="program-day">
            <div class="program-day-image" style="background-image: url('${imageUrl}');">
              <div class="program-day-badges">
                <div class="program-day-badge">–î–µ–Ω—å ${program.day || index + 1}</div>
                ${dayDate ? `<div class="program-day-badge">${dayDate}</div>` : ''}
              </div>
            </div>
            <div class="program-day-content">
              <div class="program-day-description">
                ${paragraphs.length > 0 
                  ? paragraphs.map(p => `<p>${p.trim()}</p>`).join('')
                  : `<p>${programText}</p>`
                }
              </div>
            </div>
          </div>
        `;
      }).join('');

      programsSection.style.display = 'block';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç—É—Ä–∞
    async function loadTourGallery(tourId, galleryEl, gallerySection) {
      try {
        const response = await fetch(`${API_URL}/tours/${tourId}/images`);
        if (!response.ok) {
          // –ï—Å–ª–∏ –≥–∞–ª–µ—Ä–µ–∏ –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
          if (gallerySection) gallerySection.style.display = 'none';
          return;
        }
        
        const images = await response.json();
        if (!images || images.length === 0) {
          if (gallerySection) gallerySection.style.display = 'none';
          return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏
        galleryEl.innerHTML = images.map((img, index) => {
          const imageUrl = img.image_url ? (img.image_url.startsWith('http') ? img.image_url : img.image_url.startsWith('/') ? img.image_url : `/${img.image_url}`) : '';
          if (!imageUrl) return '';
          return `<img src="${imageUrl}" alt="–§–æ—Ç–æ ${index + 1}" class="tour-gallery-item" loading="lazy" onerror="this.style.display='none'" />`;
        }).filter(html => html).join('');
        
        if (galleryEl.innerHTML && gallerySection) {
          gallerySection.style.display = 'block';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏:', error);
        if (gallerySection) gallerySection.style.display = 'none';
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      loadTourData();
      initBookingForm();
    });
  </script>
</body>
</html>

